<!DOCTYPE html>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<head>

  <!-- Leaflet -->
  <link rel="stylesheet" href="leaflet/leaflet.css">
  <link rel="stylesheet" href="leaflet/leaflet.draw.css">
  <script src="leaflet/leaflet-src.js"></script>
  <script src="leaflet/leaflet.draw.js"></script>

  <!-- jQuery, required by Bootstrap -->
  <script src="jquery-1.12.1.min.js"></script>

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

<!-- Start of CSS -->
<style>
body {
  padding-top: 50px;
  padding-bottom: 50px;
}

.col-sm-4 {
/*	border: 1px solid red;*/
}

.col-sm-8 {
/*	border: 1px solid black;*/
}

#mapid {
    height: 700px;
}

/*Text*/
.title {
  padding: 40px 15px;
  text-align: center;
}

.h3 {
  text-align: center;
}



</style>


</head>


<body>
    <div class='title'>
        <h1>Early Access User Geomapper</h1>
        <h3> This application is a MarkLogic-based visualization that provides an "executive" display for locations of all MarkLogic 9 Early Access users.</h3>
    </div>

    <div class="container">
        <div class="row">
            <div class="col-sm-12"><h3>Features</h3></div>
            <br><br>
            <div class="col-sm-12">
    	        <h3>Map Display</h3><br>
              <div id="mapid"></div>


<!-- Displaying the map (in JS) -->
<script type="text/javascript">
//Example GeoJson data, need to automate this with Marketo
var geojsonFeatures = [
  {
    "type": "Feature",
    "properties":
    {
      "name": "Coors Field",
      "amenity": "Baseball Stadium",
      "popupContent": "This is where the Rockies play!",
      "show_on_map": true, //used for filter, not using a filter currently
      "color": "#ff78f0"
    },
    "geometry":
    {
      "type": "Point",
      "coordinates": [-104.99404, 39.75621] //geojson so coordinates in long, lat
    }
  },
  {
    "type": "Feature",
    "properties":
    {
      "name": "Some Name",
      "amenity": "Baseball Stadium",
      "popupContent": "This is where the Rockies play!",
      "show_on_map": true, //used for filter, not using a filter, currently
      "color": "#ff7800"
    },
    "geometry":
    {
      "type": "Point",
      "coordinates": [-100.99404, 19.75621] //geojson so coordinates in long, lat
    }
  }
];


var map = L.map('mapid').setView([35.7, -83], 4);

L.tileLayer('https://api.mapbox.com/styles/v1/liangdanica/ciqcx4m59003pbzm9p53mvq36/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoibGlhbmdkYW5pY2EiLCJhIjoiY2lxY3gzeG95MDJkbmZubmUzYmxicW5kMSJ9.5p2qxjIuC7exMGGm19XFeg',
  {
    attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
    maxZoom: 18,
    id: 'Basic',
    accessToken: 'pk.eyJ1IjoibGlhbmdkYW5pY2EiLCJhIjoiY2lxY3gzeG95MDJkbmZubmUzYmxicW5kMSJ9.5p2qxjIuC7exMGGm19XFeg'
  }).addTo(map);

//Initialize the FeatureGroup to store editable layers (shapes drawn by user)
// ref: http://leafletjs.com/2013/02/20/guest-post-draw.html
var drawnShapes = new L.FeatureGroup();
map.addLayer(drawnShapes);

//Initialize the draw control and pass it the FeatureGroup of editable layers
var drawControl = new L.Control.Draw({
  edit: { //allows editing/deleting of drawn shapes on map
    featureGroup: drawnShapes
  }, //https://github.com/Leaflet/Leaflet.draw/wiki/API-Reference#lcontroldraw
  draw: { //all shapes enabled by default
    polyline: false,
    marker: false,
    circle: false
  }
});
map.addControl(drawControl);

// Reference: https://github.com/Leaflet/Leaflet.draw
map.on('draw:created', function (e) {
  console.log('NEW SHAPE CREATED');
  var type = e.layerType,
    layer = e.layer;

    // Store type of layer to know if it is a circle,
    // type is an unused property, so it will be used for this purpose
    layer.type = type;

  if (type === 'circle') { //Save the radius
    var radius = layer.getRadius();
    layer.radius = radius; //radius is in meters
  }
  else if (type === 'polygon') {
  }
  else if (type === 'rectangle') {
  }

  drawnShapes.addLayer(layer);
});

map.on('draw:edited', function (e) {
  var layers = e.layers;
  layers.eachLayer(function (layer) {
    // loops over each edited layer
    // do whatever you want, most likely save back to db
  });
});

map.on('draw:deleted', function (e) {
  // Update db to save latest changes.
  drawnShapes.removeLayer(e.layer);

  // deleted layer automatically removed from drawnShapes
  doPost("search.sjs", "name", log, drawnShapes);

});

function log() {
  console.log("success");
}

// Copied from Jen and Jake's geoapp
function doPost(url, str, success, drawnLayer) {
  //clearResults();
  var payload = {
    searchString: str,
    //mapWindow is used for search if there are no drawn shapes on map
    mapWindow: [
      map.getBounds().getSouth(),
      map.getBounds().getWest(),
      map.getBounds().getNorth(),
      map.getBounds().getEast()
    ],
    searchRegions: drawnLayer.toGeoJSON()
  };
  $.ajax({
    type: "POST",
    url: url,
    data: JSON.stringify(payload),
    contentType: "application/json",
    dataType: "json",
    success: success
  });
}

// Draw geojson data on map, data will originate from Marketo
geojsonLayer = L.geoJson(geojsonFeatures, {
  style: function (feature) {
    return {color: feature.properties.color};
  },
  pointToLayer: function (feature, latlng) {
    var popupOptions = {maxWidth: 200};
    var popupContent = feature.properties.name;
    return new L.CircleMarker(latlng, {radius: 10, fillOpacity: 0.85})
  },
  onEachFeature: function (feature, layer) {
    layer.bindPopup(feature.properties.name);
  }
});
map.addLayer(geojsonLayer);

</script>
            </div>  <!-- colsm-12 -->
        </div> <!-- row -->
    </div> <!-- container -->


</body>
</html>
